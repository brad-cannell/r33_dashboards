{"title":"Clean DETECT tool pilot study data imported from REDCap","markdown":{"yaml":{"title":"Clean DETECT tool pilot study data imported from REDCap"},"headingText":"Overview","containsRefs":false,"markdown":"\n\n\nIn this file, we do some initial cleaning of the DETECT tool pilot study data imported from REDCap to prepare it for dashboard summary. This pilot lasted for 2 weeks, starting on 11/11/2024 and ending on 11/25/2023.\n\n\n# Load packages\n\n```{r, message= FALSE}\nlibrary(dplyr, warn.conflicts = FALSE)\nlibrary(readr)\nlibrary(purrr)\nlibrary(stringr)\nlibrary(janitor)\nlibrary(here)\n```\n\n\n# Load custom functions\n\n```{r}\nsource(here::here(\"R\", \"recoding_factoring_relocating.R\"))\nsource(here::here(\"R\", \"nums_to_na.R\"))\nsource(here::here(\"R\", \"data_cleaning_tools.R\"))\n```\n\n\n# Load data\n\n```{r, message=FALSE}\n# Raw data with numerically coded values\ntool_pilot_raw <- read_csv(here::here(\"data\", \"detect_tool_pilot\", \n                                      \"detect_tool_pilot_test_raw.csv\"))\n\n# Data labels\ntool_pilot_labels <- read_csv(\n  here::here(\"data\", \"detect_tool_pilot\",\n             \"detect_tool_pilot_test_labels_raw.csv\"))\n\n# Link data\nlink_hits <- read_csv(here::here(\"data\", \"detect_tool_pilot\",\n                                 \"detect_tool_pilot_link_hits.csv\"))\n```\n\n\n# Column name cleaning\n\nHere we will convert all variable names to snake case with double underscores \nreduced to single underscores so that everything is uniform.\n\n```{r}\ntool_pilot_raw <- clean_names(tool_pilot_raw) %>% \n  rename(ri_refer_svcs = r_refer_svcs,\n         ri_clinician_id = ri_clinician_id_2)\n```\n\n\n# Create a dataframe with variable descriptions\n\nExtract the column names from the data and labels data frames to create a data frame of variable descriptions.\n\n```{r}\n# Create list of shortened variable labels based on the descriptions/ original questions\nlabels <- c(\"Record ID\", \"Survey Identifier\", \"Survey Timestamp\", \n           \"Form start timestamp\", \"Form date\", \"Enter survey password\", \n           \"Password verification\", \"Password verification\", \"Patient MRN\", \n           \"Institution\", \"Institution\", \"Institution\", \"Baylor clinician name\", \n           \"Other Baylor clinician name\", \"Johns Hopkins clinician name\", \n           \"Other Johns Hopkins clinician name\", \"UCSF clinician name\",\n           \"Other UCSF clinician name\", \"UAB clinician name\", \n           \"Other UAB clinician name\", \"UTSW clinician name\", \n           \"Other UTSW clinician name\", \"LBJ clinician name\", \n           \"Other LBJ clinician name\", \"UTP clinician name\", \n           \"Other UTP clinician name\", \"Clinician ID\", \"Clinician name\", \n           \"Absence of necessities \", \"Environment health or safety concern\", \n           \"Environment not assessed reason\", \"Defensive\", \n           \"Caregiver not assessed reason\", \"Other reason caregiver not assessed\",\n           \"Chemically sedated\", \"Isolated\", \"Anxious\", \"Prohibited\", \"Unmet needs\", \n           \"Unexplained injuries\", \"Patient not assessed reason\", \n           \"Suspect EM\", \"Indicators observed but EM not suspected reason\", \n           \"Suspect EM reason\", \"Self-neglect suspected\", \n           \"Financial exploitation suspected\", \n           \"Emotional or psychological abuse suspected\", \n           \"Physical abuse suspected\", \"Sexual abuse suspected\", \n           \"Caregiver neglect suspected\", \"Abandonment suspected\", \n           \"Other mistreatment type suspected\", \n           \"Dont know/ Not sure of mistreatment type\", \n           \"Specific other mistreatment type suspected\", \n           \"Intend to report to APS\", \"No intention to report to APS reason\", \n           \"Other service referral\", \"Specify other service\", \n           \"Have helpful details\", \"Brief note\", \"Complete\"\n)\n\n# Combine the variable names, descriptions and labels into a dataframe\nvar_desc <- data.frame(variable = names(tool_pilot_raw),\n                       description = names(tool_pilot_labels),\n                       label = labels) %>%\n  mutate(id = row_number())\nvar_desc\n```\n\n\n# Replace labels with variable names in the label data frame\n\n```{r}\n# Create a named vector with variable names and variable descriptions \nnaming_vec <- setNames(as.list(var_desc$description),\n                               var_desc$variable)\n\n# Rename the variables using the vector\ntool_pilot <- tool_pilot_labels %>% rename(unlist(naming_vec))\n```\n\n\n# Create new variables\n\n## Replace reporting instument timestamp variable with timestamp end variable\n\nThe `reporting_instrument_timestamp` variable contains information on both the submission time and the completion status of each survey response. The variable `reporting_instrument_complete` also provides completion status information. A new variable will be created that only contains the sumbmission time and the reporting_instrument_timestamp variable will be removed.\n\n```{r}\ntool_pilot <- tool_pilot %>% \n  mutate(\n    timestamp_end = case_when(\n      is.na(reporting_instrument_timestamp) ~ NA,\n      reporting_instrument_timestamp == \"[not completed]\" ~ NA,\n      TRUE ~ reporting_instrument_timestamp\n    ),\n    timestamp_end = as.POSIXct(timestamp_end, tz = \"UTC\")\n  ) %>% relocate(c(timestamp_end, reporting_instrument_complete),\n                 .after = ri_timestamp_start) %>%\n  select(-c(reporting_instrument_timestamp))\n```\n\n## Clinician names\n\n```{r}\nclinician_names <- c(\"ri_clinician_bcm\", \"ri_clinician_bcm_oth\", \n                     \"ri_clinician_jh\", \"ri_clinician_jh_oth\", \n                     \"ri_clinician_ucsf\", \"ri_clinician_ucsf_oth\", \n                     \"ri_clinician_uab\", \"ri_clinician_uab_oth\", \n                     \"ri_clinician_utsw\", \"ri_clinician_utsw_oth\", \n                     \"ri_clinician_lbj\", \"ri_clinician_lbj_oth\", \n                     \"ri_clinician_utp\", \"ri_clinician_utp_oth\")\n\ntool_pilot <- tool_pilot %>% \n  mutate(\n    ri_clinician_id_name = coalesce(ri_clinician_utp_oth, ri_clinician_utp, \n                                     ri_clinician_lbj_oth, ri_clinician_lbj, \n                                     ri_clinician_utsw_oth, ri_clinician_utsw, \n                                     ri_clinician_uab_oth, ri_clinician_uab, \n                                     ri_clinician_ucsf_oth, ri_clinician_ucsf, \n                                     ri_clinician_jh_oth, ri_clinician_jh, \n                                     ri_clinician_bcm_oth, ri_clinician_bcm)\n    ) %>% select(-c(all_of(clinician_names))) %>%\n  relocate(ri_clinician_id_name, .after = ri_clinician_id)\n```\n\n## Numeric and factor variables\n\n### Institution\n\n```{r}\ncols <- c(\"ri_institution\", \"ri_institution_2\")\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Baylor College of Medicine - BT House Calls\" = 1, \n    \"Johns Hopkins - JHOME\" = 2, \n    \"UCSF - Care at Home Program\" = 3,\n    \"University of Alabama - UAB House Calls\" = 4, \n    \"UT Southwestern - COVE\" = 5, \n    \"UTH Houston - LBJ House Calls\" = 6,\n    \"UTH Houston - UT Physicians House Calls\" = 7\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"7cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n```{r}\ntool_pilot <- tool_pilot %>%\n  rename(calc_institution_7cat = calc_institution) %>%\n  mutate(\n    calc_institution_7cat_f = factor(\n      calc_institution_7cat, levels = as.numeric(value_labels),\n      labels = names(value_labels)\n    )\n  ) %>% relocate(calc_institution_7cat_f, .after = calc_institution_7cat)\n```\n\n### Screening items\n\n```{r}\ncols <- c(\"ri_necessities\", \"ri_environment\", \"ri_caregiver\", \"ri_sedated\", \n          \"ri_isolated\", \"ri_anxious\", \"ri_prohibited\", \"ri_unmet_needs\", \n          \"ri_injuries\")\n\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0,\n    \"Unable to assess\" = 99\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"3cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n### ri_caregiver_un_reason\n\n```{r}\ncols <- c(\"ri_caregiver_un_reason\")\n\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Caregiver not present\" = 1,\n    \"Other reason\" = 98\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n### Yes or No\n\n```{r}\ncols <- c(\"suspect_em\", \"ri_report\", \"ri_refer_svcs\", \"ri_reflection\")\n\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n### EM type\n\n```{r}\ncols <- paste0(\"ri_em_type_\", c(1:7, 98, 99))\n\n### Change factor labels from \"checked\" and \"unchecked\" to \"Yes\" and \"No\"\ntool_pilot <- tool_pilot %>% \n  mutate(\n    across(\n      .cols = all_of(cols),\n      .fns = ~ case_when(\n        .x == \"Checked\" ~ \"Yes\",\n        .x == \"Unchecked\" ~ \"No\"\n      )\n    )\n  )\n```\n\n\n```{r}\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n\n# Remove variables without important research data\n\n```{r}\ntool_pilot <- tool_pilot %>% \n  select(-c(redcap_survey_identifier, password_entry, password_incorrect_1, \n            ri_clinician_name))\n```\n\n\n# Filter only data for dates relevant to the pilot\n\n```{r}\n# Create sequence of relevant dates\ndates <- c(seq(as.Date('2024-11-11'), as.Date('2024-11-25'), by = \"day\"))\n\n# Filter the ri_date variable to include only dates in\n# sequence\ntool_pilot <- tool_pilot %>% filter(as.Date(ri_date) %in% dates)\n```\n\n\n# Update variable descriptions dataframe with new variables\n\n```{r}\ntool_pilot_vars <- names(tool_pilot) %>% \n  # Subset new variables\n  setdiff(., var_desc$variable) %>%\n  list() %>%\n  # Convert list of new variables into dataframe\n  as.data.frame(col.names = \"variable\") %>%\n  # Join descriptions from var_desc dataframe to new data frame \n  mutate(\n    no_suffix = gsub(\"_[0-9]+cat[_f]*\", \"\", x = variable)\n  ) %>% inner_join(var_desc, by = c(\"no_suffix\" = \"variable\")) %>%\n  # remove \"no_suffix\" variable\n  select(-c(no_suffix))\n\nvar_desc <- bind_rows(var_desc, tool_pilot_vars) %>% \n  add_row(variable = \"timestamp_end\", description = \"Form end timestamp\",\n          label = \"Form start timestamp\", id = 62) %>% arrange(id) %>% \n  add_row(variable = \"ri_clinician_id_name\", description = \"Clinician name\",\n          label = \"Clinician name\", id = 28) %>% arrange(id) %>%\n  select(-c(id))\n\n```\n\n\n# Convert link hits data into a longer format\n\n```{r}\nlink_hits <- link_hits %>% \n  tidyr::pivot_longer(!date, names_to = \"link\", values_to = \"hits\")\n```\n\n\n# Save data\n\n```{r}\nwrite_rds(tool_pilot, here::here(\"data\", \"detect_tool_pilot\",\n                                 \"detect_tool_pilot.RDS\"))\n\nwrite_rds(var_desc, here::here(\"data\", \"detect_tool_pilot\", \n                               \"detect_tool_pilot_variable_descriptions.RDS\"))\n\nwrite_rds(link_hits, here::here(\"data\", \"detect_tool_pilot\",\n                               \"detect_tool_pilot_link_hits_long_format.RDS\"))\n```\n","srcMarkdownNoYaml":"\n\n# Overview\n\nIn this file, we do some initial cleaning of the DETECT tool pilot study data imported from REDCap to prepare it for dashboard summary. This pilot lasted for 2 weeks, starting on 11/11/2024 and ending on 11/25/2023.\n\n\n# Load packages\n\n```{r, message= FALSE}\nlibrary(dplyr, warn.conflicts = FALSE)\nlibrary(readr)\nlibrary(purrr)\nlibrary(stringr)\nlibrary(janitor)\nlibrary(here)\n```\n\n\n# Load custom functions\n\n```{r}\nsource(here::here(\"R\", \"recoding_factoring_relocating.R\"))\nsource(here::here(\"R\", \"nums_to_na.R\"))\nsource(here::here(\"R\", \"data_cleaning_tools.R\"))\n```\n\n\n# Load data\n\n```{r, message=FALSE}\n# Raw data with numerically coded values\ntool_pilot_raw <- read_csv(here::here(\"data\", \"detect_tool_pilot\", \n                                      \"detect_tool_pilot_test_raw.csv\"))\n\n# Data labels\ntool_pilot_labels <- read_csv(\n  here::here(\"data\", \"detect_tool_pilot\",\n             \"detect_tool_pilot_test_labels_raw.csv\"))\n\n# Link data\nlink_hits <- read_csv(here::here(\"data\", \"detect_tool_pilot\",\n                                 \"detect_tool_pilot_link_hits.csv\"))\n```\n\n\n# Column name cleaning\n\nHere we will convert all variable names to snake case with double underscores \nreduced to single underscores so that everything is uniform.\n\n```{r}\ntool_pilot_raw <- clean_names(tool_pilot_raw) %>% \n  rename(ri_refer_svcs = r_refer_svcs,\n         ri_clinician_id = ri_clinician_id_2)\n```\n\n\n# Create a dataframe with variable descriptions\n\nExtract the column names from the data and labels data frames to create a data frame of variable descriptions.\n\n```{r}\n# Create list of shortened variable labels based on the descriptions/ original questions\nlabels <- c(\"Record ID\", \"Survey Identifier\", \"Survey Timestamp\", \n           \"Form start timestamp\", \"Form date\", \"Enter survey password\", \n           \"Password verification\", \"Password verification\", \"Patient MRN\", \n           \"Institution\", \"Institution\", \"Institution\", \"Baylor clinician name\", \n           \"Other Baylor clinician name\", \"Johns Hopkins clinician name\", \n           \"Other Johns Hopkins clinician name\", \"UCSF clinician name\",\n           \"Other UCSF clinician name\", \"UAB clinician name\", \n           \"Other UAB clinician name\", \"UTSW clinician name\", \n           \"Other UTSW clinician name\", \"LBJ clinician name\", \n           \"Other LBJ clinician name\", \"UTP clinician name\", \n           \"Other UTP clinician name\", \"Clinician ID\", \"Clinician name\", \n           \"Absence of necessities \", \"Environment health or safety concern\", \n           \"Environment not assessed reason\", \"Defensive\", \n           \"Caregiver not assessed reason\", \"Other reason caregiver not assessed\",\n           \"Chemically sedated\", \"Isolated\", \"Anxious\", \"Prohibited\", \"Unmet needs\", \n           \"Unexplained injuries\", \"Patient not assessed reason\", \n           \"Suspect EM\", \"Indicators observed but EM not suspected reason\", \n           \"Suspect EM reason\", \"Self-neglect suspected\", \n           \"Financial exploitation suspected\", \n           \"Emotional or psychological abuse suspected\", \n           \"Physical abuse suspected\", \"Sexual abuse suspected\", \n           \"Caregiver neglect suspected\", \"Abandonment suspected\", \n           \"Other mistreatment type suspected\", \n           \"Dont know/ Not sure of mistreatment type\", \n           \"Specific other mistreatment type suspected\", \n           \"Intend to report to APS\", \"No intention to report to APS reason\", \n           \"Other service referral\", \"Specify other service\", \n           \"Have helpful details\", \"Brief note\", \"Complete\"\n)\n\n# Combine the variable names, descriptions and labels into a dataframe\nvar_desc <- data.frame(variable = names(tool_pilot_raw),\n                       description = names(tool_pilot_labels),\n                       label = labels) %>%\n  mutate(id = row_number())\nvar_desc\n```\n\n\n# Replace labels with variable names in the label data frame\n\n```{r}\n# Create a named vector with variable names and variable descriptions \nnaming_vec <- setNames(as.list(var_desc$description),\n                               var_desc$variable)\n\n# Rename the variables using the vector\ntool_pilot <- tool_pilot_labels %>% rename(unlist(naming_vec))\n```\n\n\n# Create new variables\n\n## Replace reporting instument timestamp variable with timestamp end variable\n\nThe `reporting_instrument_timestamp` variable contains information on both the submission time and the completion status of each survey response. The variable `reporting_instrument_complete` also provides completion status information. A new variable will be created that only contains the sumbmission time and the reporting_instrument_timestamp variable will be removed.\n\n```{r}\ntool_pilot <- tool_pilot %>% \n  mutate(\n    timestamp_end = case_when(\n      is.na(reporting_instrument_timestamp) ~ NA,\n      reporting_instrument_timestamp == \"[not completed]\" ~ NA,\n      TRUE ~ reporting_instrument_timestamp\n    ),\n    timestamp_end = as.POSIXct(timestamp_end, tz = \"UTC\")\n  ) %>% relocate(c(timestamp_end, reporting_instrument_complete),\n                 .after = ri_timestamp_start) %>%\n  select(-c(reporting_instrument_timestamp))\n```\n\n## Clinician names\n\n```{r}\nclinician_names <- c(\"ri_clinician_bcm\", \"ri_clinician_bcm_oth\", \n                     \"ri_clinician_jh\", \"ri_clinician_jh_oth\", \n                     \"ri_clinician_ucsf\", \"ri_clinician_ucsf_oth\", \n                     \"ri_clinician_uab\", \"ri_clinician_uab_oth\", \n                     \"ri_clinician_utsw\", \"ri_clinician_utsw_oth\", \n                     \"ri_clinician_lbj\", \"ri_clinician_lbj_oth\", \n                     \"ri_clinician_utp\", \"ri_clinician_utp_oth\")\n\ntool_pilot <- tool_pilot %>% \n  mutate(\n    ri_clinician_id_name = coalesce(ri_clinician_utp_oth, ri_clinician_utp, \n                                     ri_clinician_lbj_oth, ri_clinician_lbj, \n                                     ri_clinician_utsw_oth, ri_clinician_utsw, \n                                     ri_clinician_uab_oth, ri_clinician_uab, \n                                     ri_clinician_ucsf_oth, ri_clinician_ucsf, \n                                     ri_clinician_jh_oth, ri_clinician_jh, \n                                     ri_clinician_bcm_oth, ri_clinician_bcm)\n    ) %>% select(-c(all_of(clinician_names))) %>%\n  relocate(ri_clinician_id_name, .after = ri_clinician_id)\n```\n\n## Numeric and factor variables\n\n### Institution\n\n```{r}\ncols <- c(\"ri_institution\", \"ri_institution_2\")\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Baylor College of Medicine - BT House Calls\" = 1, \n    \"Johns Hopkins - JHOME\" = 2, \n    \"UCSF - Care at Home Program\" = 3,\n    \"University of Alabama - UAB House Calls\" = 4, \n    \"UT Southwestern - COVE\" = 5, \n    \"UTH Houston - LBJ House Calls\" = 6,\n    \"UTH Houston - UT Physicians House Calls\" = 7\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"7cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n```{r}\ntool_pilot <- tool_pilot %>%\n  rename(calc_institution_7cat = calc_institution) %>%\n  mutate(\n    calc_institution_7cat_f = factor(\n      calc_institution_7cat, levels = as.numeric(value_labels),\n      labels = names(value_labels)\n    )\n  ) %>% relocate(calc_institution_7cat_f, .after = calc_institution_7cat)\n```\n\n### Screening items\n\n```{r}\ncols <- c(\"ri_necessities\", \"ri_environment\", \"ri_caregiver\", \"ri_sedated\", \n          \"ri_isolated\", \"ri_anxious\", \"ri_prohibited\", \"ri_unmet_needs\", \n          \"ri_injuries\")\n\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0,\n    \"Unable to assess\" = 99\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"3cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n### ri_caregiver_un_reason\n\n```{r}\ncols <- c(\"ri_caregiver_un_reason\")\n\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Caregiver not present\" = 1,\n    \"Other reason\" = 98\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n### Yes or No\n\n```{r}\ncols <- c(\"suspect_em\", \"ri_report\", \"ri_refer_svcs\", \"ri_reflection\")\n\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n### EM type\n\n```{r}\ncols <- paste0(\"ri_em_type_\", c(1:7, 98, 99))\n\n### Change factor labels from \"checked\" and \"unchecked\" to \"Yes\" and \"No\"\ntool_pilot <- tool_pilot %>% \n  mutate(\n    across(\n      .cols = all_of(cols),\n      .fns = ~ case_when(\n        .x == \"Checked\" ~ \"Yes\",\n        .x == \"Unchecked\" ~ \"No\"\n      )\n    )\n  )\n```\n\n\n```{r}\nget_values(tool_pilot, cols)\n```\n\n```{r}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n\n\n# Remove variables without important research data\n\n```{r}\ntool_pilot <- tool_pilot %>% \n  select(-c(redcap_survey_identifier, password_entry, password_incorrect_1, \n            ri_clinician_name))\n```\n\n\n# Filter only data for dates relevant to the pilot\n\n```{r}\n# Create sequence of relevant dates\ndates <- c(seq(as.Date('2024-11-11'), as.Date('2024-11-25'), by = \"day\"))\n\n# Filter the ri_date variable to include only dates in\n# sequence\ntool_pilot <- tool_pilot %>% filter(as.Date(ri_date) %in% dates)\n```\n\n\n# Update variable descriptions dataframe with new variables\n\n```{r}\ntool_pilot_vars <- names(tool_pilot) %>% \n  # Subset new variables\n  setdiff(., var_desc$variable) %>%\n  list() %>%\n  # Convert list of new variables into dataframe\n  as.data.frame(col.names = \"variable\") %>%\n  # Join descriptions from var_desc dataframe to new data frame \n  mutate(\n    no_suffix = gsub(\"_[0-9]+cat[_f]*\", \"\", x = variable)\n  ) %>% inner_join(var_desc, by = c(\"no_suffix\" = \"variable\")) %>%\n  # remove \"no_suffix\" variable\n  select(-c(no_suffix))\n\nvar_desc <- bind_rows(var_desc, tool_pilot_vars) %>% \n  add_row(variable = \"timestamp_end\", description = \"Form end timestamp\",\n          label = \"Form start timestamp\", id = 62) %>% arrange(id) %>% \n  add_row(variable = \"ri_clinician_id_name\", description = \"Clinician name\",\n          label = \"Clinician name\", id = 28) %>% arrange(id) %>%\n  select(-c(id))\n\n```\n\n\n# Convert link hits data into a longer format\n\n```{r}\nlink_hits <- link_hits %>% \n  tidyr::pivot_longer(!date, names_to = \"link\", values_to = \"hits\")\n```\n\n\n# Save data\n\n```{r}\nwrite_rds(tool_pilot, here::here(\"data\", \"detect_tool_pilot\",\n                                 \"detect_tool_pilot.RDS\"))\n\nwrite_rds(var_desc, here::here(\"data\", \"detect_tool_pilot\", \n                               \"detect_tool_pilot_variable_descriptions.RDS\"))\n\nwrite_rds(link_hits, here::here(\"data\", \"detect_tool_pilot\",\n                               \"detect_tool_pilot_link_hits_long_format.RDS\"))\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../assets/custom_style.css"],"toc":true,"output-file":"data_01_detect_tool_pilot_test.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.549","page-layout":"full","theme":["cosmo","../assets/custom_style.css"],"title":"Clean DETECT tool pilot study data imported from REDCap"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}